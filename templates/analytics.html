<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>QR Analytics</title>

<style>
:root{
    --primary:#3b82f6;
    --primary-light:#60a5fa;
    --bg:#f8fafc;
    --card:#ffffff;
    --border:#e2e8f0;
    --text:#0f172a;
    --muted:#64748b;
    --success:#10b981;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background:var(--bg);
    color:var(--text);
    font-size:14px;
}

.container{
    max-width:1400px;
    margin:0 auto;
    padding:24px;
}

/* Header */
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
}

.header-left h1{
    font-size:20px;
    font-weight:700;
    display:flex;
    align-items:center;
    gap:8px;
}

.live-badge{
    background:#e0f2fe;
    color:#0284c7;
    font-size:10px;
    font-weight:700;
    padding:3px 8px;
    border-radius:4px;
}

.subtitle{
    font-size:13px;
    color:var(--muted);
    margin-top:4px;
}

.header-actions{
    display:flex;
    gap:10px;
}

.btn{
    padding:8px 14px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.2s;
}

.btn:hover{
    background:#f8fafc;
}

.btn-primary{
    background:var(--primary);
    color:#fff;
    border-color:var(--primary);
}

.btn-primary:hover{
    background:var(--primary-light);
}

/* Filters */
.filters{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px;
    margin-bottom:20px;
}

.filter-row{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
}

.filter-group label{
    display:block;
    font-size:12px;
    font-weight:600;
    margin-bottom:6px;
    color:var(--text);
}

.filter-group select,
.filter-group input{
    width:100%;
    padding:8px 10px;
    border:1px solid var(--border);
    border-radius:6px;
    font-size:13px;
}

/* Stats */
.stats{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:16px;
    margin-bottom:20px;
}

.stat-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px;
}

.stat-label{
    font-size:12px;
    color:var(--muted);
    text-transform:uppercase;
    font-weight:600;
    letter-spacing:0.5px;
}

.stat-value{
    font-size:32px;
    font-weight:700;
    margin:8px 0 4px;
}

.stat-change{
    font-size:12px;
    color:var(--success);
    font-weight:600;
}

/* Chart Section */
.chart-section{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:10px;
    padding:20px;
    margin-bottom:20px;
}

.section-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
}

.section-title{
    font-size:14px;
    font-weight:700;
}

.section-subtitle{
    font-size:12px;
    color:var(--muted);
}

.chart-legend{
    display:flex;
    gap:16px;
    font-size:12px;
}

.legend-item{
    display:flex;
    align-items:center;
    gap:6px;
}

.legend-dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:var(--primary);
}

.chart{
    height:200px;
    display:flex;
    align-items:flex-end;
    gap:2px;
    margin-top:16px;
}

.bar{
    flex:1;
    background:var(--primary);
    border-radius:3px 3px 0 0;
    min-height:2px;
    position:relative;
    cursor:pointer;
}

.bar:hover{
    opacity:0.8;
}

.bar-label{
    position:absolute;
    bottom:-20px;
    left:50%;
    transform:translateX(-50%);
    font-size:10px;
    color:var(--muted);
    white-space:nowrap;
}

/* Grid */
.grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
    margin-bottom:20px;
}

/* Locations */
.location-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 0;
    border-bottom:1px solid var(--border);
}

.location-item:last-child{
    border-bottom:none;
}

.location-name{
    font-size:13px;
    font-weight:500;
}

.location-count{
    font-size:13px;
    font-weight:700;
    color:var(--primary);
}

.percentage{
    font-size:11px;
    color:var(--muted);
    margin-left:4px;
}

/* Device Circle */
.device-circle{
    width:180px;
    height:180px;
    border-radius:50%;
    border:20px solid var(--primary);
    display:flex;
    align-items:center;
    justify-content:center;
    margin:20px auto;
    font-size:36px;
    font-weight:700;
}

.device-list{
    margin-top:16px;
}

.device-item{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
    font-size:13px;
}

.device-icon{
    width:20px;
    text-align:center;
}

.device-label{
    flex:1;
    color:var(--muted);
}

.device-value{
    font-weight:600;
}

/* Table */
.table-section{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:10px;
    padding:20px;
}

.table-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
}

.filter-link{
    color:var(--primary);
    font-size:12px;
    font-weight:600;
    text-decoration:none;
    cursor:pointer;
}

.filter-link:hover{
    text-decoration:underline;
}

table{
    width:100%;
    border-collapse:collapse;
}

th{
    text-align:left;
    font-size:11px;
    color:var(--muted);
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.5px;
    padding:8px 0;
    border-bottom:1px solid var(--border);
}

td{
    padding:12px 0;
    font-size:13px;
    border-bottom:1px solid var(--border);
}

.device-badge{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:4px 8px;
    background:#f1f5f9;
    border-radius:4px;
    font-size:12px;
}

.view-all-link{
    text-align:center;
    padding:16px;
    color:var(--primary);
    font-size:13px;
    font-weight:600;
    cursor:pointer;
}

.view-all-link:hover{
    text-decoration:underline;
}

.no-data{
    text-align:center;
    padding:40px;
    color:var(--muted);
}
</style>
</head>

<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>
                QR Code ID #<span id="qrCodeName">-</span> Analytics
                <span class="live-badge">‚óè TIMEZONE-AWARE</span>
            </h1>
            <p class="subtitle">Real-time scan data, frequency analysis</p>
        </div>
        <div class="header-actions">
            <button class="btn" onclick="window.location.href='/dashboard'">‚Üê Dashboard</button>
            <button class="btn btn-primary" onclick="exportData()">üìä Export Report</button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters">
        <div class="filter-row">
            <div class="filter-group">
                <label>QR Code</label>
                <select id="qrSelect" onchange="loadAnalytics()"></select>
            </div>
            
            <div class="filter-group">
                <label>Time Range</label>
                <select id="timeRange" onchange="toggleDates();loadAnalytics()">
                    <option value="today">Today</option>
                    <option value="7days">7 Days</option>
                    <option value="30days" selected>30 Days</option>
                    <option value="90days">90 Days</option>
                    <option value="custom">Custom</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Start Date</label>
                <input type="date" id="startDate" disabled />
            </div>

            <div class="filter-group">
                <label>End Date</label>
                <input type="date" id="endDate" disabled />
            </div>

            <div class="filter-group" style="display:flex;align-items:flex-end">
                <button class="btn btn-primary" style="width:100%" onclick="applyDates()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-label">Total Scans</div>
            <div class="stat-value" id="totalScans">-</div>
            <div class="stat-change" id="totalChange">-</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Today</div>
            <div class="stat-value" id="todayScans">-</div>
            <div class="stat-change" id="todayChange">-</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Mobile</div>
            <div class="stat-value" id="mobilePercent">-</div>
            <div class="stat-change">Dominant</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Peak Hour</div>
            <div class="stat-value" id="peakHour">-</div>
            <div class="stat-change" id="peakLabel">-</div>
        </div>
    </div>

    <!-- Chart -->
    <div class="chart-section">
        <div class="section-header">
            <div>
                <div class="section-title">Hourly Scan Distribution</div>
                <div class="section-subtitle">Real-time hourly frequency analysis</div>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-dot"></span>
                    <span>SCANS</span>
                </div>
                <div class="legend-item">
                    <span style="color:var(--muted)">AVERAGE</span>
                </div>
            </div>
        </div>
        <div class="chart" id="hourlyChart"></div>
    </div>

    <!-- Grid -->
    <div class="grid">
        <!-- Locations -->
        <div class="chart-section">
            <div class="section-header">
                <div class="section-title">Top Locations</div>
            </div>
            <div id="locationsList"></div>
        </div>

        <!-- Device Insights -->
        <div class="chart-section">
            <div class="section-header">
                <div class="section-title">Device Insights</div>
            </div>
            <div class="device-circle" id="deviceCircle">-</div>
            <div class="device-list" id="deviceList"></div>
        </div>
    </div>

    <!-- Live Scan Log -->
    <div class="table-section">
        <div class="table-header">
            <div>
                <div class="section-title">Live Scan Log</div>
                <div class="section-subtitle">Real-time live scan receiver 10 scans</div>
            </div>
            <a class="filter-link">üîÑ Live Monitoring Active</a>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Device</th>
                    <th>Browser</th>
                    <th>City</th>
                    <th>OS</th>
                </tr>
            </thead>
            <tbody id="scanTable"></tbody>
        </table>

        <div class="view-all-link" onclick="alert('View full activity log')">
            View All Activity Log ‚Üí
        </div>
    </div>
</div>

<script>
const API = 'https://social-media-vmfr.onrender.com';

function getToken(){
    return localStorage.getItem('token');
}

function checkAuth(){
    if(!getToken()) window.location.href='/';
}

function toggleDates(){
    const isCustom = document.getElementById('timeRange').value === 'custom';
    document.getElementById('startDate').disabled = !isCustom;
    document.getElementById('endDate').disabled = !isCustom;
}

function applyDates(){
    if(document.getElementById('timeRange').value === 'custom'){
        loadAnalytics();
    }
}

function exportData(){
    alert('Export functionality: Generate PDF/Excel report with current analytics data');
}

async function loadQRList(){
    const res = await fetch(`${API}/api/qr`,{
        headers:{Authorization:`Bearer ${getToken()}`}
    });

    if(res.status===401){ window.location.href='/'; return; }

    const qrCodes = await res.json();
    const select = document.getElementById('qrSelect');

    if(qrCodes.length===0){
        select.innerHTML='<option>No QR codes</option>';
        return;
    }

    select.innerHTML = qrCodes.map(qr =>
        `<option value="${qr.id}">${qr.code} (${qr.scan_count} scans)</option>`
    ).join('');

    loadAnalytics();
}

async function loadAnalytics(){
    const qrId = document.getElementById('qrSelect').value;
    if(!qrId) return;

    const timeRange = document.getElementById('timeRange').value;
    const params = new URLSearchParams({timezone: 'Asia/Kolkata'});

    if(timeRange === 'custom'){
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if(start && end){
            params.append('start_date', start);
            params.append('end_date', end);
        }
    }else{
        params.append('time_range', timeRange);
    }

    const res = await fetch(`${API}/api/qr/${qrId}/analytics?${params}`,{
        headers:{Authorization:`Bearer ${getToken()}`}
    });

    const data = await res.json();
    
    // Update QR name
    const qrRes = await fetch(`${API}/api/qr/${qrId}`,{
        headers:{Authorization:`Bearer ${getToken()}`}
    });
    const qrData = await qrRes.json();
    document.getElementById('qrCodeName').textContent = qrData.code;

    renderStats(data);
    renderChart(data);
    renderLocations(data);
    renderDevices(data);
    renderTable(data);
}

function renderStats(data){
    document.getElementById('totalScans').textContent = data.total_scans;
    document.getElementById('totalChange').textContent = '+20%';
    
    document.getElementById('todayScans').textContent = data.scans_today;
    document.getElementById('todayChange').textContent = '+8%';
    
    document.getElementById('mobilePercent').textContent = `${data.mobile_percentage}%`;
    
    const peak = data.peak_hour;
    if(peak !== null){
        const hour = peak > 12 ? peak - 12 : (peak === 0 ? 12 : peak);
        const period = peak >= 12 ? 'PM' : 'AM';
        document.getElementById('peakHour').textContent = `${hour} ${period}`;
        document.getElementById('peakLabel').textContent = 'Most Active';
    }else{
        document.getElementById('peakHour').textContent = '-';
        document.getElementById('peakLabel').textContent = 'No data';
    }
}

function renderChart(data){
    const chart = document.getElementById('hourlyChart');
    const max = Math.max(...data.hourly_breakdown.map(h=>h.count), 1);
    
    chart.innerHTML = data.hourly_breakdown.map(h=>{
        const height = (h.count / max) * 100;
        const label = h.hour === 0 ? '12AM' : 
                     h.hour < 12 ? `${h.hour}AM` : 
                     h.hour === 12 ? '12PM' : `${h.hour-12}PM`;
        
        return `<div class="bar" style="height:${height}%" title="${label}: ${h.count} scans">
            ${h.hour % 3 === 0 ? `<div class="bar-label">${label}</div>` : ''}
        </div>`;
    }).join('');
}

function renderLocations(data){
    const list = document.getElementById('locationsList');
    
    if(data.top_cities.length === 0){
        list.innerHTML = '<div class="no-data">No location data</div>';
        return;
    }

    const total = data.top_cities.reduce((sum, l) => sum + l.count, 0);
    
    list.innerHTML = data.top_cities.map(loc=>{
        const percent = ((loc.count / total) * 100).toFixed(0);
        return `
            <div class="location-item">
                <div class="location-name">${loc.city || 'Unknown'}</div>
                <div>
                    <span class="location-count">${loc.count} scans</span>
                    <span class="percentage">[${percent}%]</span>
                </div>
            </div>
        `;
    }).join('');
}

function renderDevices(data){
    const circle = document.getElementById('deviceCircle');
    const list = document.getElementById('deviceList');
    
    circle.textContent = `${data.mobile_percentage}%`;
    
    const devices = [
        {icon:'üì±', label:'Mobile', value:data.device_breakdown.mobile},
        {icon:'üíª', label:'Desktop', value:data.device_breakdown.desktop},
        {icon:'üì≤', label:'Tablet', value:data.device_breakdown.tablet}
    ];
    
    list.innerHTML = devices.map(d=>`
        <div class="device-item">
            <span class="device-icon">${d.icon}</span>
            <span class="device-label">${d.label}</span>
            <span class="device-value">${d.value}</span>
        </div>
    `).join('');
}

function renderTable(data){
    const table = document.getElementById('scanTable');
    
    if(data.recent_scans.length === 0){
        table.innerHTML = '<tr><td colspan="5" class="no-data">No recent scans</td></tr>';
        return;
    }

    table.innerHTML = data.recent_scans.map(scan=>{
        const date = new Date(scan.scanned_at);
        const time = date.toLocaleString('en-US', {
            month:'2-digit',
            day:'2-digit',
            hour:'2-digit',
            minute:'2-digit',
            hour12:true
        });
        
        return `
            <tr>
                <td>${time}</td>
                <td><span class="device-badge">üì± ${scan.device_type || 'Unknown'}</span></td>
                <td>${scan.browser || '-'}</td>
                <td>${scan.city || 'Unknown'}</td>
                <td>${scan.os || '-'}</td>
            </tr>
        `;
    }).join('');
}

checkAuth();
loadQRList();
</script>

</body>
</html>