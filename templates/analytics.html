<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>QR Analytics</title>

<style>
:root{
    --primary:#3b8be1;
    --primary-dark:#3b8be1;
    --bg:#f9fafb;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --success:#3b8be1;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background:var(--bg);
    color:var(--text);
}

/* ===== Layout ===== */
.app{
    display:grid;
    grid-template-columns:240px 1fr;
    min-height:100vh;
}

.main{
    padding:32px 40px;
    max-width:1400px;
}

/* ===== Sidebar ===== */
.sidebar{
    background:var(--card);
    border-right:1px solid var(--border);
    padding:24px 16px;
}

.brand{
    display:flex;
    align-items:center;
    gap:12px;
    font-weight:700;
    font-size:16px;
    margin-bottom:40px;
    padding:0 8px;
}

.brand-icon{
    background:var(--primary);
    color:#fff;
    width:36px;
    height:36px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:8px;
    font-size:18px;
}

.nav{
    display:flex;
    flex-direction:column;
    gap:4px;
}

.nav a{
    padding:10px 12px;
    border-radius:8px;
    text-decoration:none;
    color:var(--muted);
    font-weight:500;
    font-size:14px;
    transition:all 0.2s;
}

.nav a.active{
    background:#f0fdf4;
    color:var(--primary-dark);
}

.nav a:hover{
    background:#f9fafb;
}

/* ===== Header ===== */
.header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    margin-bottom:32px;
}

.header h1{
    font-size:24px;
    font-weight:700;
    margin-bottom:4px;
}

.header p{
    font-size:14px;
    color:var(--muted);
}

.live-badge{
    background:#3b8be1;
    color:#fff;
    font-size:10px;
    font-weight:700;
    padding:4px 8px;
    border-radius:4px;
    margin-left:8px;
    vertical-align:middle;
}

.header-actions{
    display:flex;
    gap:12px;
}

/* ===== Buttons ===== */
.btn{
    padding:10px 18px;
    border-radius:8px;
    border:none;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    transition:all 0.2s;
}

.btn-outline{
    background:#fff;
    border:1px solid var(--border);
    color:var(--text);
}

.btn-outline:hover{
    background:#f9fafb;
}

.btn-primary{
    background:var(--primary);
    color:#fff;
}

.btn-primary:hover{
    background:var(--primary-dark);
}

/* ===== Selector ===== */
.selector{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:24px;
}

.selector label{
    font-weight:600;
    font-size:13px;
    color:var(--text);
    display:block;
    margin-bottom:8px;
}

.selector select{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:14px;
    background:#fff;
}

/* ===== Stats ===== */
.stats{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:20px;
    margin-bottom:28px;
}

.stat-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    position:relative;
}

.stat-icon{
    position:absolute;
    top:16px;
    right:16px;
    width:32px;
    height:32px;
    background:#f0fdf4;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--primary);
    font-size:16px;
}

.stat-card h4{
    font-size:13px;
    color:var(--muted);
    margin-bottom:8px;
    font-weight:500;
}

.stat-value{
    font-size:32px;
    font-weight:700;
    margin-bottom:4px;
}

.stat-sub{
    font-size:12px;
    color:var(--success);
    font-weight:500;
}

/* ===== Sections ===== */
.section{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
}

.section-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
}

.section-title{
    font-weight:700;
    font-size:16px;
}

.section-subtitle{
    font-size:13px;
    color:var(--muted);
    font-weight:400;
}

.badge-success{
    background:#d1fae5;
    color:#3b8be1;
    font-size:11px;
    font-weight:600;
    padding:4px 10px;
    border-radius:12px;
}

/* ===== Chart ===== */
.chart{
    height:200px;
    display:flex;
    align-items:flex-end;
    gap:3px;
    padding-top:20px;
}

.bar{
    flex:1;
    background:var(--primary);
    border-radius:3px 3px 0 0;
    min-height:3px;
    transition:all 0.3s;
}

.bar:hover{
    opacity:0.8;
}

/* ===== Grid ===== */
.grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:24px;
}

/* ===== Geographic ===== */
.geo-content{
    display:grid;
    grid-template-columns:160px 1fr;
    gap:24px;
    align-items:center;
}

.map-placeholder{
    width:140px;
    height:140px;
    background:#d1fae5;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:60px;
}

.location-list{
    display:flex;
    flex-direction:column;
    gap:12px;
}

.location-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px 0;
}

.location-name{
    font-size:14px;
    color:var(--text);
}

.location-flag{
    margin-right:8px;
}

.location-count{
    font-weight:700;
    color:var(--primary);
}

.heatmap-label{
    text-align:center;
    font-size:11px;
    color:var(--muted);
    margin-top:12px;
    font-weight:500;
}

/* ===== Device Chart ===== */
.device-content{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:20px;
    padding:20px 0;
}

.circle{
    width:160px;
    height:160px;
    border-radius:50%;
    border:16px solid var(--primary);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:32px;
    color:var(--text);
}

.device-details{
    width:100%;
}

.device-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px 0;
    font-size:14px;
}

.device-label{
    color:var(--muted);
}

.device-value{
    font-weight:600;
    color:var(--text);
}

.device-bar{
    width:100%;
    height:6px;
    background:#f3f4f6;
    border-radius:3px;
    margin-top:4px;
    overflow:hidden;
}

.device-fill{
    height:100%;
    background:var(--primary);
    border-radius:3px;
}

/* ===== Table ===== */
table{
    width:100%;
    border-collapse:collapse;
}

th{
    text-align:left;
    font-size:11px;
    color:var(--muted);
    padding-bottom:12px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.5px;
}

td{
    padding:14px 0;
    border-top:1px solid var(--border);
    font-size:13px;
}

.no-data{
    text-align:center;
    padding:60px;
    color:var(--muted);
}

.view-all{
    color:var(--primary);
    font-size:13px;
    font-weight:600;
    text-decoration:none;
    cursor:pointer;
}

.view-all:hover{
    text-decoration:underline;
}
</style>
</head>

<body>

<div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-icon">üì±</div>
            QR Manager
        </div>

        <nav class="nav">
            <a href="/dashboard">QR Codes</a>
            <a href="/analytics" class="active">Analytics</a>
            <a href="#">Campaigns</a>
            <a href="#">Team Settings</a>
        </nav>
    </aside>

    <!-- Main -->
    <main class="main">

        <!-- Header -->
        <div class="header">
            <div>
                <h1>
                    QR Code ID #2 Analytics
                    <span class="live-badge">LIVE</span>
                </h1>
                <p>Real-time scan data and visitor insights from worldwide campaigns</p>
            </div>

            <div class="header-actions">
                <button class="btn btn-outline" onclick="window.location.href='/dashboard'">
                    Last 24 Hours
                </button>
                <button class="btn btn-primary">‚¨á Export Report</button>
            </div>
        </div>

        <!-- Selector -->
        <div class="selector">
            <label>Select QR Code</label>
            <select id="qrSelect" onchange="loadAnalytics()">
                <option>Loading...</option>
            </select>
        </div>

        <div id="analyticsContent"></div>

    </main>
</div>

<script>
const API = 'https://social-media-vmfr.onrender.com';

function getToken(){
    return localStorage.getItem('token');
}

function checkAuth(){
    if(!getToken()) window.location.href='/';
}

async function loadQRList(){
    const res = await fetch(`${API}/api/qr`,{
        headers:{Authorization:`Bearer ${getToken()}`}
    });

    if(res.status===401){ window.location.href='/'; return; }

    const qrCodes = await res.json();
    const select = document.getElementById('qrSelect');

    if(qrCodes.length===0){
        select.innerHTML='<option>No QR codes</option>';
        return;
    }

    select.innerHTML = qrCodes.map(qr =>
        `<option value="${qr.id}">${qr.code} (${qr.scan_count} scans)</option>`
    ).join('');

    loadAnalytics();
}

async function loadAnalytics(){
    const qrId = document.getElementById('qrSelect').value;
    const content = document.getElementById('analyticsContent');

    if(!qrId){
        content.innerHTML='<div class="no-data">Select a QR code</div>';
        return;
    }

    const res = await fetch(`${API}/api/qr/${qrId}/analytics`,{
        headers:{Authorization:`Bearer ${getToken()}`}
    });

    const data = await res.json();
    const max = Math.max(...data.hourly_breakdown.map(h=>h.count),1);

    content.innerHTML = `
        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <h4>Total Scans</h4>
                <div class="stat-value">${data.total_scans}</div>
                <div class="stat-sub">‚Üë 100% vs yesterday</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <h4>Today</h4>
                <div class="stat-value">${data.scans_today}</div>
                <div class="stat-sub">Last scan at 09:15 AM</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è∞</div>
                <h4>Peak Hour</h4>
                <div class="stat-value">${data.peak_hour !== null ? data.peak_hour + ' AM' : '-'}</div>
                <div class="stat-sub">Local time (IST)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì±</div>
                <h4>Mobile %</h4>
                <div class="stat-value">${data.mobile_percentage}%</div>
                <div style="width:100%;height:4px;background:#f0fdf4;border-radius:2px;margin-top:8px">
                    <div style="width:${data.mobile_percentage}%;height:100%;background:var(--primary);border-radius:2px"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div>
                    <div class="section-title">Hourly Scan Activity</div>
                    <div class="section-subtitle">Detailed breakdown of scans across 24 hours</div>
                </div>
                <span class="badge-success">‚úì Successful Scans</span>
            </div>
            <div class="chart">
                ${data.hourly_breakdown.map(h=>{
                    const height=(h.count/max)*100;
                    return `<div class="bar" style="height:${height}%"></div>`;
                }).join('')}
            </div>
        </div>

        <div class="grid">
            <div class="section">
                <div class="section-header">
                    <div>
                        <div class="section-title">Geographic Reach</div>
                        <div class="section-subtitle">Visitor distribution by city and country</div>
                    </div>
                </div>
                <div class="geo-content">
                    <div>
                        <div class="map-placeholder">üó∫Ô∏è</div>
                        <div class="heatmap-label">GLOBAL SCAN HEATMAP</div>
                    </div>
                    <div class="location-list">
                        ${data.top_cities.length ? data.top_cities.map(l=>`
                            <div class="location-item">
                                <div class="location-name">
                                    <span class="location-flag">üáÆüá≥</span>
                                    ${l.city || 'Unknown'}, ${l.country || 'Unknown'}
                                </div>
                                <div class="location-count">${l.count} scans</div>
                            </div>
                        `).join('') : '<p class="no-data">No location data available</p>'}
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div>
                        <div class="section-title">Device Details</div>
                        <div class="section-subtitle">User agents and browser platforms</div>
                    </div>
                </div>
                <div class="device-content">
                    <div class="circle">${data.mobile_percentage}%</div>
                    <div class="device-details">
                        <div>
                            <div class="device-row">
                                <span class="device-label">üì± Platform: Android</span>
                                <span class="device-value">${data.mobile_percentage}%</span>
                            </div>
                            <div class="device-bar">
                                <div class="device-fill" style="width:${data.mobile_percentage}%"></div>
                            </div>
                        </div>
                        <div style="margin-top:12px">
                            <div class="device-row">
                                <span class="device-label">üåê Browser: Chrome</span>
                                <span class="device-value">${data.mobile_percentage}%</span>
                            </div>
                            <div class="device-bar">
                                <div class="device-fill" style="width:${data.mobile_percentage}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div>
                    <div class="section-title">Recent Activity</div>
                    <div class="section-subtitle">Real-time log of most recent interactions</div>
                </div>
                <a href="#" class="view-all">View all activity ‚Üí</a>
            </div>
            <table>
                <tr>
                    <th>Timestamp</th>
                    <th>Location</th>
                    <th>Device</th>
                    <th>Browser</th>
                    <th>Action</th>
                </tr>
                ${data.recent_scans.length ? data.recent_scans.map(s=>`
                    <tr>
                        <td>${new Date(s.scanned_at).toLocaleString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</td>
                        <td>üìç ${s.city || 'Unknown'}, ${s.country || 'Unknown'}</td>
                        <td>${s.device_type || 'Unknown'}</td>
                        <td>${s.browser || 'Unknown'}</td>
                        <td style="color:var(--muted)">‚ãÆ</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="no-data">No scans yet</td></tr>'}
            </table>
            ${data.recent_scans.length ? `
                <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--muted)">
                    Showing 1-10 of total records ‚Ä¢ All time in Asia/Kolkata (IST)
                </div>
            ` : ''}
        </div>
    `;
}

checkAuth();
loadQRList();
</script>

</body>
</html>